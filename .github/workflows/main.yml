name: Build APK (Ubuntu 22.04 Fix)
on:
  push:
    branches: [ "main", "master" ]

jobs:
  build:
    # تغییر مهم: استفاده از نسخه پایدار 22.04 برای رفع خطای autoconf
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ۱. اصلاح خودکار کد پایتون (چون فایل شما ناقص بود)
      - name: Fix Python Code
        run: |
          # ساخت مجدد فایل main.py با کد صحیح و کامل
          cat > main.py <<EOF
          import kivy
          from kivy.app import App
          from kivy.uix.gridlayout import GridLayout
          from kivy.properties import ObjectProperty

          class MainLayout(GridLayout):
              display = ObjectProperty(None)

              def calc(self, event):
                  if event:
                      try:
                          self.display.text = str(eval(event))
                      except Exception:
                          self.display.text = "Error"

          class MyCalculatorApp(App):
              def build(self):
                  return MainLayout()

          if __name__ == '__main__':
              MyCalculatorApp().run()
          EOF
          
          # حذف فایل قدیمی اگر هست
          rm -f mycalculator.py
          echo "Python code fixed and renamed to main.py"

      # ۲. نصب جاوا ۱۷
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # ۳. نصب پایتون
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # ۴. نصب وابستگی‌ها (اضافه شدن libltdl-dev برای رفع ارور شما)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential git python3-dev \
          ffmpeg libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev \
          libsdl2-ttf-dev libportmidi-dev libswscale-dev \
          libavformat-dev libavcodec-dev zlib1g-dev autoconf \
          automake libtool pkg-config libffi-dev libssl-dev \
          libltdl-dev libncurses5-dev zip unzip

      # ۵. نصب بیلدوزر
      - name: Install Buildozer
        run: |
          pip install --upgrade pip
          pip install buildozer cython==0.29.33

      # ۶. تنظیم فایل spec
      - name: Configure Buildozer
        run: |
          buildozer init
          sed -i 's/title = My Application/title = Calculator/' buildozer.spec
          sed -i 's/package.name = myapp/package.name = mycalculator/' buildozer.spec
          sed -i 's/requirements = python3,kivy/requirements = python3,kivy/' buildozer.spec
          # تایید لایسنس
          sed -i 's/#android.accept_sdk_license = False/android.accept_sdk_license = True/' buildozer.spec
          # تغییر معماری برای سرعت بیشتر (فقط arm64)
          sed -i 's/#android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec

      # ۷. ساخت APK
      - name: Build APK
        run: |
          yes | buildozer -v android debug

      # ۸. آپلود فایل نهایی
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: calculator-apk
          path: bin/*.apk
